<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <base data-ice="baseUrl" href="../../../">
  <title data-ice="title">src/server/server.es6.js | API Document</title>
  <link type="text/css" rel="stylesheet" href="css/style.css">
  <link type="text/css" rel="stylesheet" href="css/prettify-tomorrow.css">
  <script src="script/prettify/prettify.js"></script>
  
  
  <script src="script/manual.js"></script>
</head>
<body class="layout-container" data-ice="rootContainer">

<header>
  <a href="./">Home</a>
  <a href="./manual/index.html" data-ice="manualHeaderLink">Manual</a>
  <a href="identifiers.html">Reference</a>
  <a href="source.html">Source</a>
  
  <a data-ice="repoURL" href="https://github.com/collective-soundworks/soundworks" class="repo-url-github">Repository</a>
  <div class="search-box">
  <span>
    <img src="./image/search.png">
    <span class="search-input-edge"></span><input class="search-input"><span class="search-input-edge"></span>
  </span>
    <ul class="search-result"></ul>
  </div>
</header>

<nav class="navigation" data-ice="nav"><div>
  <ul>
    
  <li data-ice="doc"><div data-ice="dirPath" class="nav-dir-path">client</div><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/client/ClientCalibration.es6.js~ClientCalibration.html">ClientCalibration</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/client/ClientControl.es6.js~ClientControl.html">ClientControl</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/client/ClientDialog.es6.js~ClientDialog.html">ClientDialog</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/client/ClientFilelist.es6.js~Filelist.html">Filelist</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/client/ClientLoader.es6.js~ClientLoader.html">ClientLoader</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/client/ClientLocator.es6.js~ClientLocator.html">ClientLocator</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/client/ClientModule.es6.js~ClientModule.html">ClientModule</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/client/ClientOrientation.es6.js~ClientOrientation.html">ClientOrientation</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/client/ClientPerformance.es6.js~ClientPerformance.html">ClientPerformance</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/client/ClientPlacer.es6.js~ClientPlacer.html">ClientPlacer</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/client/ClientPlatform.es6.js~ClientPlatform.html">ClientPlatform</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/client/ClientSelector.es6.js~ClientSelector.html">ClientSelector</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/client/ClientSetup.es6.js~ClientSetup.html">ClientSetup</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/client/ClientSync.es6.js~ClientSync.html">ClientSync</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-variable">V</span><span data-ice="name"><span><a href="variable/index.html#static-variable-EventEmitter">EventEmitter</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-variable">V</span><span data-ice="name"><span><a href="variable/index.html#static-variable-client">client</a></span></span></li>
<li data-ice="doc"><div data-ice="dirPath" class="nav-dir-path">server</div><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/server/ServerCalibration.es6.js~ServerCalibration.html">ServerCalibration</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/server/ServerClient.es6.js~ServerClient.html">ServerClient</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/server/ServerControl.es6.js~ServerControl.html">ServerControl</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/server/ServerModule.es6.js~ServerModule.html">ServerModule</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/server/ServerSync.es6.js~ServerSync.html">ServerSync</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-variable">V</span><span data-ice="name"><span><a href="variable/index.html#static-variable-server">server</a></span></span></li>
</ul>
</div>
</nav>

<div class="content" data-ice="content"><h1 data-ice="title">src/server/server.es6.js</h1>
<pre class="source-code line-number raw-source-code"><code class="prettyprint linenums" data-ice="content">&apos;use strict&apos;;

const ejs = require(&apos;ejs&apos;);
const express = require(&apos;express&apos;);
const fs = require(&apos;fs&apos;);
const http = require(&apos;http&apos;);
const log = require(&apos;./logger&apos;);
const IO = require(&apos;socket.io&apos;);
const osc = require(&apos;osc&apos;);
const path = require(&apos;path&apos;);

import ServerClient from &apos;./ServerClient.es6.js&apos;;

/**
 * The `server` object contains the basic methods of the server. For instance, this object allows setting up, configuring and starting the server with the method `start` while the method `map` allows for managing the mapping between different types of clients and their required server modules. Additionally, the method `broadcast` allows to send messages to all connected clients.
 */
const server = {
  io: null,
  start: start,
  map: map,
  broadcast: broadcast,
  envConfig: {}, // host env config informations (dev / prod)
  osc: null,
  sendOSC: sendOSC,
  receiveOSC: receiveOSC
};

let availableClientIndices = [];
let nextClientIndex = 0;
let oscListeners = [];
let expressApp = null;
let httpServer = null;

function _getClientIndex() {
  var index = -1;

  if (availableClientIndices.length &gt; 0) {
    availableClientIndices.sort(function(a, b) {
      return a - b;
    });

    index = availableClientIndices.splice(0, 1)[0];
  } else {
    index = nextClientIndex++;
  }

  return index;
}

function _releaseClientIndex(index) {
  availableClientIndices.push(index);
}

function start(app, publicPath, port, options = {}) {
  const socketIOOptions = (options.socketIO ||&#xA0;{});
  const socketConfig = {
    transports: socketIOOptions.transports ||&#xA0;[&apos;websocket&apos;],
    pingTimeout: socketIOOptions.pingTimeout ||&#xA0;60000,
    pingInterval: socketIOOptions.pingInterval ||&#xA0;50000,
  };

  server.envConfig = options.env;

  app.set(&apos;port&apos;, process.env.PORT || port || 8000);
  app.set(&apos;view engine&apos;, &apos;ejs&apos;);
  app.use(express.static(publicPath));

  httpServer = http.createServer(app);
  expressApp = app;

  httpServer.listen(app.get(&apos;port&apos;), function() {
    console.log(&apos;Server listening on port&apos;, app.get(&apos;port&apos;));
  });

  // Engine IO defaults
  // this.pingTimeout = opts.pingTimeout || 3000;
  // this.pingInterval = opts.pingInterval || 1000;
  // this.upgradeTimeout = opts.upgradeTimeout || 10000;
  // this.maxHttpBufferSize = opts.maxHttpBufferSize || 10E7;

  if (httpServer) {
    server.io = new IO(httpServer, socketConfig);
  }

  // OSC
  if (options.osc) {
    server.osc = new osc.UDPPort({
      // This is the port we&apos;re listening on.
      localAddress: options.osc.localAddress || &apos;127.0.0.1&apos;,
      localPort: options.osc.localPort || 57121,

      // This is the port we use to send messages.
      remoteAddress: options.osc.remoteAddress || &apos;127.0.0.1&apos;,
      remotePort: options.osc.remotePort || 57120,
    });

    server.osc.on(&apos;ready&apos;, () =&gt; {
      console.log(&apos;Listening for OSC over UDP on port &apos; + options.osc.localPort + &apos;.&apos;);
    });

    server.osc.on(&apos;message&apos;, (oscMsg) =&gt; {
      const address = oscMsg.address;

      for (let i = 0; i &lt; oscListeners.length; i++) {
        if (address === oscListeners[i].wildcard)
          oscListeners[i].callback(oscMsg);
      }
    });

    server.osc.open();
  }
}

/**
 * Indicates that the clients of type `clientType` require the modules `...modules` on the server side.
 * Additionally, this method routes the connections from the corresponding URL to the corresponding view.
 * More specifically:
 * - A client connecting to the server through the root URL `http://my.server.address:port/` is considered as a `&apos;player&apos;` client and displays the view `player.ejs`;
 * - A client connecting to the server through the URL `http://my.server.address:port/clientType` is considered as a `clientType` client, and displays the view `clientType.ejs`.
 * @param {[type]} clientType Client type (as defined by the method {@link client.init} on the client side).
 * @param {[type]} ...modules [description]
 * @return {[type]} [description]
 */
function map(clientType, ...modules) {
  var url = &apos;/&apos;;

  // cache compiled template
  const tmplPath= path.join(process.cwd(), &apos;views&apos;, clientType + &apos;.ejs&apos;);
  const tmplString = fs.readFileSync(tmplPath, { encoding: &apos;utf8&apos; });
  const tmpl = ejs.compile(tmplString);

  if (clientType !== &apos;player&apos;)
    url += clientType;

  expressApp.get(url, function(req, res) {
    res.send(tmpl({ envConfig: JSON.stringify(server.envConfig) }));
  });

  server.io.of(clientType).on(&apos;connection&apos;, (socket) =&gt; {
    log.info({ socket: socket, clientType: clientType }, &apos;connection&apos;);
    var client = new ServerClient(clientType, socket);

    var index = _getClientIndex();
    client.index = index;

    for (let mod of modules) {
      mod.connect(client);
    }

    client.receive(&apos;disconnect&apos;, () =&gt; {
      log.info({ socket: socket, clientType: clientType }, &apos;disconnect&apos;);
      for (let i = modules.length - 1; i &gt;= 0; i--) {
        var mod = modules[i];
        mod.disconnect(client);
      }

      _releaseClientIndex(client.index);
      client.index = -1;
    });

    client.send(&apos;client:start&apos;, index); // the server is ready
  });
}

/**
 * Sends a WebSocket message to all the clients of type `clientType`.
 *
 * **Note:** on the client side, the clients receive the message with the method {@link client.receive}.
 * @param {String} clientType Client type (as defined by the method {@link client.init} on the client side).
 * @param {String} msg Name of the message to send.
 * @param {...*} args Arguments of the message (as many as needed, of any type).
 * @todo solve ... problem
 */
function broadcast(clientType, msg, ...args) {
  if (server.io) {
    log.info({ clientType: clientType, channel: msg, arguments: args }, &apos;broadcast&apos;);
    server.io.of(&apos;/&apos; + clientType).emit(msg, ...args);
  }
}

/**
 * Sends an OSC message.
 * @param {String} wildcard Wildcard of the OSC message.
 * @param {Array} args Arguments of the OSC message.
 * @param {String} [url=null] URL to send the OSC message to (if not specified, uses the address defined in the OSC config or in the options of the {@link server.start} method).
 * @param {Number} [port=null] Port to send the message to (if not specified, uses the port defined in the OSC config or in the options of the {@link server.start} method).
 */
function sendOSC(wildcard, args, url = null, port = null) {
  const oscMsg = {
    address: wildcard,
    args: args
  };

  if (url &amp;&amp; port)
    server.osc.send(oscMsg, url, port);
  else
    server.osc.send(oscMsg); // use defaults (as defined in the config)
}

/**
 * Executes a callback function when it receives an OSC message.
 * The server listens to OSC messages at the address and port defined in the config or in the options of the {@link server.start} method.
 *
 * @param {String} wildcard Wildcard of the OSC message.
 * @param {Function} callback Callback function executed when the OSC message is received.
 */
function receiveOSC(wildcard, callback) {
  const oscListener = {
    wildcard: wildcard,
    callback: callback
  };

  oscListeners.push(oscListener);
}

export default server;
</code></pre>

</div>

<footer class="footer">
  Generated by <a href="https://esdoc.org">ESDoc<span data-ice="esdocVersion">(0.4.1)</span></a>
</footer>

<script src="script/search_index.js"></script>
<script src="script/search.js"></script>
<script src="script/pretty-print.js"></script>
<script src="script/inherited-summary.js"></script>
<script src="script/test-summary.js"></script>
<script src="script/inner-link.js"></script>
<script src="script/patch-for-local.js"></script>
</body>
</html>
