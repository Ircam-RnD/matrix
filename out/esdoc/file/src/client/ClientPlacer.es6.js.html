<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <base data-ice="baseUrl" href="../../../">
  <title data-ice="title">src/client/ClientPlacer.es6.js | API Document</title>
  <link type="text/css" rel="stylesheet" href="css/style.css">
  <link type="text/css" rel="stylesheet" href="css/prettify-tomorrow.css">
  <script src="script/prettify/prettify.js"></script>
  
  
  <script src="script/manual.js"></script>
</head>
<body class="layout-container" data-ice="rootContainer">

<header>
  <a href="./">Home</a>
  <a href="./manual/index.html" data-ice="manualHeaderLink">Manual</a>
  <a href="identifiers.html">Reference</a>
  <a href="source.html">Source</a>
  
  <a data-ice="repoURL" href="https://github.com/collective-soundworks/soundworks" class="repo-url-github">Repository</a>
  <div class="search-box">
  <span>
    <img src="./image/search.png">
    <span class="search-input-edge"></span><input class="search-input"><span class="search-input-edge"></span>
  </span>
    <ul class="search-result"></ul>
  </div>
</header>

<nav class="navigation" data-ice="nav"><div>
  <ul>
    
  <li data-ice="doc"><div data-ice="dirPath" class="nav-dir-path">client</div><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/client/ClientCalibration.es6.js~ClientCalibration.html">ClientCalibration</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/client/ClientControl.es6.js~ClientControl.html">ClientControl</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/client/ClientDialog.es6.js~ClientDialog.html">ClientDialog</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/client/ClientLoader.es6.js~ClientLoader.html">ClientLoader</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/client/ClientModule.es6.js~ClientModule.html">ClientModule</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/client/ClientOrientation.es6.js~ClientOrientation.html">ClientOrientation</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/client/ClientPerformance.es6.js~ClientPerformance.html">ClientPerformance</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/client/ClientPlatform.es6.js~ClientPlatform.html">ClientPlatform</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/client/ClientSync.es6.js~ClientSync.html">ClientSync</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-variable">V</span><span data-ice="name"><span><a href="variable/index.html#static-variable-ClientModule">ClientModule</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-variable">V</span><span data-ice="name"><span><a href="variable/index.html#static-variable-EventEmitter">EventEmitter</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-variable">V</span><span data-ice="name"><span><a href="variable/index.html#static-variable-client">client</a></span></span></li>
<li data-ice="doc"><div data-ice="dirPath" class="nav-dir-path">server</div><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/server/ServerCalibration.es6.js~ServerCalibration.html">ServerCalibration</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/server/ServerClient.es6.js~ServerClient.html">ServerClient</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/server/ServerControl.es6.js~ServerControl.html">ServerControl</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/server/ServerModule.es6.js~ServerModule.html">ServerModule</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/server/ServerSync.es6.js~ServerSync.html">ServerSync</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-variable">V</span><span data-ice="name"><span><a href="variable/index.html#static-variable-server">server</a></span></span></li>
</ul>
</div>
</nav>

<div class="content" data-ice="content"><h1 data-ice="title">src/client/ClientPlacer.es6.js</h1>
<pre class="source-code line-number raw-source-code"><code class="prettyprint linenums" data-ice="content">const ClientModule = require(&apos;./ClientModule&apos;);
const ClientSpace = require(&apos;./ClientSpace&apos;);
const client = require(&apos;./client&apos;);
const EventEmitter = require(&apos;events&apos;).EventEmitter;


// display strategies for placer
class ListSelector extends EventEmitter {
  constructor(options) {
    this._indexPositionMap = new Map();
    this._onSelect = this._onSelect.bind(this);
  }

  _onSelect(e) {
    const options = this.select.options;
    const selectedIndex = this.select.selectedIndex;
    const index = parseInt(options[selectedIndex].value, 10);
    const position = this._indexPositionMap.get(index);
    this.emit(&apos;select&apos;, position);
  }

  display(setup, container, options = {}) {
    this.container = container;
    this.el = document.createElement(&apos;div&apos;);

    this.select = document.createElement(&apos;select&apos;);
    this.button = document.createElement(&apos;button&apos;);
    this.button.textContent = &apos;OK&apos;;
    this.button.classList.add(&apos;btn&apos;);

    this.el.appendChild(this.select);
    this.el.appendChild(this.button);
    this.container.appendChild(this.el);

    this.button.addEventListener(&apos;touchstart&apos;, this._onSelect, false);
    this.resize();
  }

  resize() {
    if (!this.container) { return; } // if called before `display`

    const containerWidth = this.container.getBoundingClientRect().width;
    const containerHeight = this.container.getBoundingClientRect().height;

    const height = this.el.getBoundingClientRect().height;
    const width = containerWidth * 2 / 3;
    const left = containerWidth / 3 / 2;
    const top = (containerHeight - height) / 2;

    this.el.style.position = &apos;absolute&apos;;
    this.el.style.width = width + &apos;px&apos;;
    this.el.style.top = top + &apos;px&apos;;
    this.el.style.left = left + &apos;px&apos;;

    this.select.style.width = width + &apos;px&apos;;
    this.button.style.width = width + &apos;px&apos;;
  }

  displayPositions(positions) {
    positions.forEach((position) =&gt; {
      const option = document.createElement(&apos;option&apos;);
      option.value = position.index;
      option.textContent = position.label;

      this.select.appendChild(option);
      this._indexPositionMap.set(position.index, position);
    });
  }
}

class ClientPlacer extends ClientModule {
  constructor(options = {}) {
    super(options.name ||&#xA0;&apos;placer&apos;, true);

    this.setup = options.setup;
    this.mode = options.mode ||&#xA0;&apos;list&apos;;
    this.persist = options.persist ||&#xA0;false;
    this.localStorageId = options.localStorageId ||&#xA0;&apos;soundworks&apos;;

    switch (this.mode) {
      case &apos;graphic&apos;:
        this.selector = new ClientSpace({
          fitContainer: true,
          listenTouchEvent: true,
        });
        break;
      case &apos;list&apos;:
        this.selector = new ListSelector({});
        break;
    }

    this._resizeSelector = this._resizeSelector.bind(this);
    window.addEventListener(&apos;resize&apos;, this._resizeSelector, false);
    // allow to reset localStorage
    client.receive(`${this.name}:reset`, this._deleteInformation);

    // DEBUG
    // this._deleteInformation();
  }

  _resizeSelector() {
    this.selector.resize();
  }

  _getStorageKey() {
    return `${this.localStorageId}:${this.name}`;
  }

  _persistInformation(position) {
    // if options.expire add th timestamp to the position object
    const key = this._getStorageKey();
    window.localStorage.setItem(key, JSON.stringify(position));
  }

  _retrieveInformation() {
    const key = this._getStorageKey();
    const position = window.localStorage.getItem(key);

    // check for expires entry
    // delete if now &gt; expires
    return JSON.parse(position);
  }

  _deleteInformation() {
    const key = this._getStorageKey();
    window.localStorage.removeItem(key);
    // window.localStorage.clear(); // remove everything for the domain
  }

  _sendInformation(position = null) {
    if (position !== null) {
      this.index = position.index;
      this.label = position.label;
      client.coordinates = position.coordinates;
    }

    client.send(
      `${this.name}:information`,
      this.index,
      this.label,
      client.coordinates
    );
  }

  start() {
    super.start();

    // prepare positions
    this.positions = this.setup.coordinates.map((coord, index) =&gt; {
      return {
        index: index,
        label: this.setup.labels[index],
        coordinates: coord,
      };
    });

    // check for informations in local storage
    if (this.persist) {
      const position = this._retrieveInformation();

      if (position !== null) {
        this._sendInformation(position);
        return this.done();
      }
    }

    // listen for selection
    this.selector.on(&apos;select&apos;, (position) =&gt; {
      // optionally store in local storage
      if (this.persist) {
        this._persistInformation(position);
      }
      // send to server
      this._sendInformation(position);
      this.done();
    });

    this.selector.display(this.setup, this.view, {});
    // make sure the DOM is ready (needed on ipods)
    setTimeout(() =&gt; {
      this.selector.displayPositions(this.positions, 20);
    }, 0);
  }

  restart() {
    super.restart();
    this._sendInformation();
  }

  reset() {
    super.reset();
    // reset client
    this.index = null;
    this.label = null;
    client.coordinates = null;
    // remove listener
    this.selector.removeAllListeners(&apos;select&apos;);
  }

  done() {
    super.done();
    window.removeEventListener(&apos;resize&apos;, this._resizeSelector, false);
    this.selector.removeAllListeners(&apos;select&apos;);
  }
}

module.exports = ClientPlacer;
</code></pre>

</div>

<footer class="footer">
  Generated by <a href="https://esdoc.org">ESDoc<span data-ice="esdocVersion">(0.4.1)</span></a>
</footer>

<script src="script/search_index.js"></script>
<script src="script/search.js"></script>
<script src="script/pretty-print.js"></script>
<script src="script/inherited-summary.js"></script>
<script src="script/test-summary.js"></script>
<script src="script/inner-link.js"></script>
<script src="script/patch-for-local.js"></script>
</body>
</html>
