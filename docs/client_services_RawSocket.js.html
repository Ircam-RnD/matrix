<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>Soundworks - Source: client/services/RawSocket.js</title>

    <script src="scripts/prettify/prettify.js"> </script>
    <script src="scripts/prettify/lang-css.js"> </script>
    <!--[if lt IE 9]>
      <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    <link type="text/css" rel="stylesheet" href="styles/prettify-tomorrow.css">
    <link type="text/css" rel="stylesheet" href="styles/jsdoc-default.css">
    <link type="text/css" rel="stylesheet" href="styles/overrides.css">
</head>

<body>

<div id="main">

    <!-- if home page assume a title is already present in README -->
    
    <h1 class="page-title">Source: client/services/RawSocket.js</h1>
    

    



    
    <section>
        <article>
            <pre class="prettyprint source linenums"><code>import SegmentedView from '../views/SegmentedView';
import Service from '../core/Service';
import serviceManager from '../core/serviceManager';

const SERVICE_ID = 'service:raw-socket';

/**
 * Interface for the `raw-socket` service.
 *
 * This service creates an additionnal native socket with its binary type set
 * to `arraybuffer` and focused on performances.
 * It allows the transfert of `TypedArray` data wrapped with a minimal channel
 * mechanism (up to 256 channels).
 *
 * __*The service must be used with its [server-side counterpart]{@link module:soundworks/server.RawSocket}*__
 *
 * @memberof module:soundworks/client
 */
class RawSocket extends Service {
  constructor() {
    super(SERVICE_ID, true);

    const defaults = {
      viewCtor: SegmentedView,
      viewPriority: 5,
    };

    this.configure(defaults);

    /**
     * Listeners for the incomming messages.
     *
     * @type {Object&lt;String, Set&lt;Function>>}
     * @name _listeners
     * @memberof module:soundworks/server.RawSocket
     * @instance
     * @private
     */
    this._listeners = {};

    this._protocol = null;
    this._onReceiveConnectionInfos = this._onReceiveConnectionInfos.bind(this);
    this._onReceiveAcknoledgement = this._onReceiveAcknoledgement.bind(this);
    this._onMessage = this._onMessage.bind(this);
  }

  /** @private */
  start() {
    super.start();
    this.show();

    super.send('request');
    super.receive('infos', this._onReceiveConnectionInfos);
  }

  /** @private */
  stop() {
    this.hide();
    super.stop();
  }

  /**
   * Method executed when the service receive connection informations from the
   * server.
   *
   * @param {Number} port - Port on which open the new socket.
   * @param {Object} protocol - User-defined protocol to be used in raw socket
   *  exchanges.
   * @param {Number} token - Unique token to retrieve in the first message to
   *  identy the client server-side, allow to match the socket with its
   *  corresponding client.
   *
   * @private
   */
  _onReceiveConnectionInfos(port, protocol, token) {
    this._protocol = protocol;
    this._channels = protocol.map((entry) => entry.channel);

    this.removeListener('connection-infos', this._onReceiveConnectionInfos);

    const socketProtocol = window.location.protocol.replace(/^http?/, 'ws');
    const socketHostname = window.location.hostname;
    const url = `${socketProtocol}//${socketHostname}:${port}`;

    this.socket = new WebSocket(url);
    this.socket.binaryType = 'arraybuffer';
    // send token back to the server and wait for acknoledgement
    const data = new Uint32Array(1);
    data[0] = token;

    this.socket.addEventListener('open', () => {
      this.send('service:handshake', data);
    });

    this.socket.addEventListener('message', this._onReceiveAcknoledgement);
  }

  /**
   * Callback executed when the server acknoledges the matching between a
   * client and a socket.
   *
   * @private
   */
  _onReceiveAcknoledgement(e) {
    const index = new Uint8Array(e.data)[0];
    const { channel, type } = this._protocol[index];

    // ignore incomming messages that could occur if
    // acknoledgement was not yet received
    if (channel === 'service:handshake-ack')Â {
      this.socket.removeEventListener('message', this._onReceiveAcknoledgement);
      this.socket.addEventListener('message', this._onMessage);
      this.ready();
    }
  }

  /**
   * Callback function of the socket `message` event. Unwrap the channel and
   * the data contained in the payload and execute the registered callback.
   *
   * @private
   */
  _onMessage(e) {
    const index = new Uint8Array(e.data)[0];

    if (!this._protocol[index])
      throw new Error(`Invalid protocol index: ${index}`);

    const { channel, type } = this._protocol[index];
    const viewCtor = window[`${type}Array`];
    const data = new viewCtor(e.data, viewCtor.BYTES_PER_ELEMENT);
    const callbacks = this._listeners[channel];

    if (callbacks)
      callbacks.forEach((callback) => callback(data));
  }

  /**
   * Register a callback to be executed when receiving a message on a specific
   * channel.
   *
   * @param {String} channel - Channel of the message.
   * @param {Function} callback - Callback function.
   */
  receive(channel, callback) {
    const listeners = this._listeners;

    if (!listeners[channel])
      listeners[channel] = new Set();

    listeners[channel].add(callback);
  }

  /**
   * Send data on a specific channel.
   *
   * @param {String} channel - Channel of the message.
   * @param {TypedArray} data - Data.
   */
  send(channel, data) {
    const index = this._channels.indexOf(channel);

    if (index === -1)
      throw new Error(`Undefined channel "${channel}"`);

    const { type } = this._protocol[index];
    const viewCtor = window[`${type}Array`];
    const size = data ? 1 + data.length : 1;
    const view = new viewCtor(size);

    const channelView = new Uint8Array(viewCtor.BYTES_PER_ELEMENT);
    channelView[0] = index;
    // populate buffer
    view.set(new viewCtor(channelView.buffer), 0);

    if (data)
      view.set(data, 1);

    this.socket.send(view.buffer);
  }
}

serviceManager.register(SERVICE_ID, RawSocket);

export default RawSocket;
</code></pre>
        </article>
    </section>




</div>

<nav>
    <h2><a href="index.html">Home</a></h2><h3>Modules</h3><ul><li><a href="module-soundworks_client.html">soundworks/client</a></li><li><a href="module-soundworks_server.html">soundworks/server</a></li></ul><h3>Classes</h3><ul><li><a href="module-soundworks_client.Activity.html">soundworks/client.Activity</a></li><li><a href="module-soundworks_client.AudioBufferManager.html">soundworks/client.AudioBufferManager</a></li><li><a href="module-soundworks_client.AudioScheduler.html">soundworks/client.AudioScheduler</a></li><li><a href="module-soundworks_client.AudioStreamManager.html">soundworks/client.AudioStreamManager</a></li><li><a href="module-soundworks_client.AudioStreamManager.AudioStream.html">soundworks/client.AudioStreamManager.AudioStream</a></li><li><a href="module-soundworks_client.Auth.html">soundworks/client.Auth</a></li><li><a href="module-soundworks_client.Canvas2dRenderer.html">soundworks/client.Canvas2dRenderer</a></li><li><a href="module-soundworks_client.Canvas2dRenderingGroup.html">soundworks/client.Canvas2dRenderingGroup</a></li><li><a href="module-soundworks_client.CanvasView.html">soundworks/client.CanvasView</a></li><li><a href="module-soundworks_client.Checkin.html">soundworks/client.Checkin</a></li><li><a href="module-soundworks_client.ErrorReporter.html">soundworks/client.ErrorReporter</a></li><li><a href="module-soundworks_client.Experience.html">soundworks/client.Experience</a></li><li><a href="module-soundworks_client.FileSystem.html">soundworks/client.FileSystem</a></li><li><a href="module-soundworks_client.Geolocation.html">soundworks/client.Geolocation</a></li><li><a href="module-soundworks_client.Locator.html">soundworks/client.Locator</a></li><li><a href="module-soundworks_client.MotionInput.html">soundworks/client.MotionInput</a></li><li><a href="module-soundworks_client.Network.html">soundworks/client.Network</a></li><li><a href="module-soundworks_client.Placer.html">soundworks/client.Placer</a></li><li><a href="module-soundworks_client.Platform.html">soundworks/client.Platform</a></li><li><a href="module-soundworks_client.RawSocket.html">soundworks/client.RawSocket</a></li><li><a href="module-soundworks_client.SegmentedView.html">soundworks/client.SegmentedView</a></li><li><a href="module-soundworks_client.Service.html">soundworks/client.Service</a></li><li><a href="module-soundworks_client.SharedConfig.html">soundworks/client.SharedConfig</a></li><li><a href="module-soundworks_client.SharedParams.html">soundworks/client.SharedParams</a></li><li><a href="module-soundworks_client.Sync.html">soundworks/client.Sync</a></li><li><a href="module-soundworks_client.SyncScheduler.html">soundworks/client.SyncScheduler</a></li><li><a href="module-soundworks_client.View.html">soundworks/client.View</a></li><li><a href="module-soundworks_server.Activity.html">soundworks/server.Activity</a></li><li><a href="module-soundworks_server.AudioBufferManager.html">soundworks/server.AudioBufferManager</a></li><li><a href="module-soundworks_server.AudioStreamManager.html">soundworks/server.AudioStreamManager</a></li><li><a href="module-soundworks_server.Auth.html">soundworks/server.Auth</a></li><li><a href="module-soundworks_server.Checkin.html">soundworks/server.Checkin</a></li><li><a href="module-soundworks_server.ErrorReporter.html">soundworks/server.ErrorReporter</a></li><li><a href="module-soundworks_server.Experience.html">soundworks/server.Experience</a></li><li><a href="module-soundworks_server.Geolocation.html">soundworks/server.Geolocation</a></li><li><a href="module-soundworks_server.Locator.html">soundworks/server.Locator</a></li><li><a href="module-soundworks_server.MetricScheduler.html">soundworks/server.MetricScheduler</a></li><li><a href="module-soundworks_server.Network.html">soundworks/server.Network</a></li><li><a href="module-soundworks_server.Osc.html">soundworks/server.Osc</a></li><li><a href="module-soundworks_server.Placer.html">soundworks/server.Placer</a></li><li><a href="module-soundworks_server.RawSocket.html">soundworks/server.RawSocket</a></li><li><a href="module-soundworks_server.Service.html">soundworks/server.Service</a></li><li><a href="module-soundworks_server.SharedConfig.html">soundworks/server.SharedConfig</a></li><li><a href="module-soundworks_server.SharedParams.html">soundworks/server.SharedParams</a></li><li><a href="module-soundworks_server.Sync.html">soundworks/server.Sync</a></li><li><a href="module-soundworks_server.SyncScheduler.html">soundworks/server.SyncScheduler</a></li></ul><h3>Namespaces</h3><ul><li><a href="module-soundworks_client.client.html">soundworks/client.client</a></li><li><a href="module-soundworks_client.viewport.html">soundworks/client.viewport</a></li><li><a href="module-soundworks_server.server.html">soundworks/server.server</a></li></ul><h3>Interfaces</h3><ul><li><a href="module-soundworks_client.AbstractAudioBufferManagerView.html">soundworks/client.AbstractAudioBufferManagerView</a></li><li><a href="module-soundworks_client.AbstractAuthView.html">soundworks/client.AbstractAuthView</a></li><li><a href="module-soundworks_client.AbstractCheckinView.html">soundworks/client.AbstractCheckinView</a></li><li><a href="module-soundworks_client.AbstractLocatorView.html">soundworks/client.AbstractLocatorView</a></li><li><a href="module-soundworks_client.AbstractPlacerView.html">soundworks/client.AbstractPlacerView</a></li><li><a href="module-soundworks_client.AbstractPlatformView.html">soundworks/client.AbstractPlatformView</a></li><li><a href="module-soundworks_client.AbstractView.html">soundworks/client.AbstractView</a></li></ul>
</nav>

<br class="clear">

<footer>
    
        Documentation generated by <a href="https://github.com/jsdoc3/jsdoc">JSDoc 3.6.3</a> on Mon Sep 23 2019 11:29:43 GMT+0200 (CEST)
    
</footer>

<script> prettyPrint(); </script>
<script src="scripts/linenumber.js"> </script>
</body>
</html>
