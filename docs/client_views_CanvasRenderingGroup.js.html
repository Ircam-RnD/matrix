<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>Soundworks - Source: client/views/CanvasRenderingGroup.js</title>

    <script src="scripts/prettify/prettify.js"> </script>
    <script src="scripts/prettify/lang-css.js"> </script>
    <!--[if lt IE 9]>
      <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    <link type="text/css" rel="stylesheet" href="styles/prettify-tomorrow.css">
    <link type="text/css" rel="stylesheet" href="styles/jsdoc-default.css">
    <link type="text/css" rel="stylesheet" href="styles/overrides.css">
</head>

<body>

<div id="main">

    <!-- if home page assume a title is already present in README -->
    
    <h1 class="page-title">Source: client/views/CanvasRenderingGroup.js</h1>
    

    



    
    <section>
        <article>
            <pre class="prettyprint source linenums"><code>/**
 * Rendering loop handling the `requestAnimationFrame` and the `update` /
 * `render` cycles.
 *
 * @private
 */
const loop = {
  renderingGroups: [],

  _isRunning: false,

  /**
   * @return {Number} - Current time in seconds.
   */
  getTime() {
    return 0.001 * (window.performance &amp;&amp; window.performance.now ?
      window.performance.now() : new Date().getTime());
  },

  /**
   * Start the rendering loop if not started.
   */
  requireStart() {
    if (this._isRunning) { return; }
    this._isRunning = true;
    this.lastRenderTime = this.getTime();

    (function(self) {
      function loop() {
        const time = self.getTime();
        const dt = time - self.lastRenderTime;
        const renderingGroups = self.renderingGroups;

        for (let i = 0, l = renderingGroups.length; i &lt; l; i++) {
          const group = renderingGroups[i];
          // let the group handle the updatePeriod of each renderer
          group.update(time, dt);
          group.render(dt); // forward `dt` for `preRender` method
        }

        self.lastRenderTime = time;
        self.rAFid = requestAnimationFrame(loop);
      }

      self.rAFid = requestAnimationFrame(loop);
    }(this));
  },

  /**
   * Stop the loop if no renderer are still present. If not abort.
   */
  requireStop() {
    // @todo - handle several parallel groups
    let shouldStop = true;

    for (let i = 0, l = this.renderingGroups.length; i &lt; l; i++) {
      if (this.renderingGroups[i].renderers.length > 0) {
        shouldStop = false;
      }
    }

    if (shouldStop) {
      cancelAnimationFrame(this.rAFid);
      this._isRunning = false;
    }
  },

  /**
   * Add a rendering group to the loop.
   */
  registerRenderingGroup(group) {
    this.renderingGroups.push(group);
  }
};

/**
 * Handle a group of renderers on a single full screen canvas.
 *
 * &lt;span class="warning">This class is a property of
 * {@link module:soundworks/client.CanvasView} should be considered private.&lt;/span>
 *
 * @param {CanvasRenderingContext2D} ctx - Canvas context in which
 *  the renderer should draw.
 * @param {Boolean} [preservePixelRatio=false] - Define if the canvas should
 *  take account of the device pixel ratio for the drawing. When set to `true`,
 *  quality if favored over performance.
 *
 * @memberof module:soundworks/client
 */
class Canvas2dRenderingGroup {
  constructor(ctx, preservePixelRatio = false, skipFrames = 0) {
    /**
     * 2d context of the canvas.
     *
     * @type {CanvasRenderingContext2D}
     * @name ctx
     * @instance
     * @memberof module:soundworks/client.Canvas2dRenderingGroup
     */
    this.ctx = ctx;

    /**
     * Stack of the registered renderers.
     *
     * @type {Array&lt;module:soundworks/client.Renderer>}
     * @name renderers
     * @instance
     * @memberof module:soundworks/client.Canvas2dRenderingGroup
     */
    this.renderers = [];

    /**
     * Hooks executed at the beginning and end of each rAF call.
     * @private
     */
    this.preRender = null;
    this.postRender = null;

    /**
     * Pixel ratio of the device, set to 1 if `false`.
     *
     * @type {Number}
     * @name pixelRatio
     * @instance
     * @memberof module:soundworks/client.Canvas2dRenderingGroup
     */
    this.pixelRatio = (function(ctx) {
      const dPR = window.devicePixelRatio || 1;
      const bPR = ctx.webkitBackingStorePixelRatio ||
        ctx.mozBackingStorePixelRatio ||
        ctx.msBackingStorePixelRatio ||
        ctx.oBackingStorePixelRatio ||
        ctx.backingStorePixelRatio || 1;

      return preservePixelRatio ? (dPR / bPR) : 1;
    }(this.ctx));

    this.frameCount = 0;
    this.frameModulo = skipFrames + 1;
    this.accumDt = 0;

    // register the group into the loop
    loop.registerRenderingGroup(this);
  }

  /**
   * Updates the size of the canvas. Propagate new logical `width` and `height`
   * according to `this.pixelRatio` to all registered renderers.
   *
   * @param {Number} viewportWidth - Width of the viewport.
   * @param {Number} viewportHeight - Height of the viewport.
   * @param {Number} orientation - Orientation of the viewport.
   */
  onResize(viewportWidth, viewportHeight, orientation) {
    const ctx = this.ctx;
    const pixelRatio = this.pixelRatio;

    this.canvasWidth = viewportWidth * pixelRatio;
    this.canvasHeight = viewportHeight * pixelRatio;
    this.orientation = orientation;

    ctx.canvas.width = this.canvasWidth;
    ctx.canvas.height = this.canvasHeight;
    ctx.canvas.style.width = `${viewportWidth}px`;
    ctx.canvas.style.height = `${viewportHeight}px`;

    // propagate logical size to renderers
    for (let i = 0, l = this.renderers.length; i &lt; l; i++)
      this.renderers[i].onResize(this.canvasWidth, this.canvasHeight, orientation);
  }

  /**
   * Propagate `update` to all registered renderers. The `update` method
   * for each renderer is called according to their update period.
   *
   * @param {Number} time - Current time.
   * @param {Number} dt - Delta time in seconds since last update.
   */
  update(time, dt) {
    const renderers = this.renderers;

    for (let i = 0, l = renderers.length; i &lt; l; i++) {
      const renderer = renderers[i];
      const updatePeriod = renderer.updatePeriod;

      if (updatePeriod === 0) {
        renderer.update(dt);
        renderer.currentTime = time;
      } else {
        while (renderer.currentTime &lt; time) {
          renderer.update(updatePeriod);
          renderer.currentTime += updatePeriod;
        }
      }
    }
  }

  /**
   * Propagate `render` to all the registered renderers.
   *
   * @param {Number} dt - Delta time in seconds since the last
   *  `requestAnimationFrame` call.
   */
  render(dt) {
    let accumDt = this.accumDt + dt;

    if (this.frameCount === 0) {
      const { ctx, renderers } = this;

      if (this.preRender !== null)
        this.preRender(ctx, accumDt, this.canvasWidth, this.canvasHeight);

      for (let i = 0, l = renderers.length; i &lt; l; i++)
        renderers[i].render(ctx);

      if (this.postRender !== null)
        this.postRender(ctx, accumDt, this.canvasWidth, this.canvasHeight);

      accumDt = 0;
    }

    this.frameCount = (this.frameCount + 1) % this.frameModulo;
    this.accumDt = accumDt;
  }

  /**
   * Add a `Renderer` instance to the group.
   *
   * @param {module:soundworks/client.Renderer} renderer - Renderer to add to
   *  the group.
   */
  add(renderer) {
    this.renderers.push(renderer);
    this.currentTime = loop.getTime();
    // update the current time of the renderer
    renderer.currentTime = this.currentTime;
    renderer.pixelRatio = this.pixelRatio;
    renderer.onResize(this.canvasWidth, this.canvasHeight, this.orientation);
    renderer.init();
    // if first renderer added, start the loop
    if (this.renderers.length === 1)
      loop.requireStart();
  }

  /**
   * Remove a `Renderer` instance from the group.
   *
   * @param {module:soundworks/client.Renderer} renderer - Renderer to remove
   *  from the group.
   */
  remove(renderer) {
    const index = this.renderers.indexOf(renderer);

    if (index !== -1) {
      this.renderers.splice(index, 1);
      // if last renderer removed, stop the loop
      if (this.renderers.length === 0)
        loop.requireStop();
    }
  }
}

export default Canvas2dRenderingGroup;
</code></pre>
        </article>
    </section>




</div>

<nav>
    <h2><a href="index.html">Home</a></h2><h3>Modules</h3><ul><li><a href="module-soundworks_client.html">soundworks/client</a></li><li><a href="module-soundworks_server.html">soundworks/server</a></li></ul><h3>Classes</h3><ul><li><a href="module-soundworks_client.Activity.html">soundworks/client.Activity</a></li><li><a href="module-soundworks_client.AudioBufferManager.html">soundworks/client.AudioBufferManager</a></li><li><a href="module-soundworks_client.AudioScheduler.html">soundworks/client.AudioScheduler</a></li><li><a href="module-soundworks_client.AudioStreamManager.html">soundworks/client.AudioStreamManager</a></li><li><a href="module-soundworks_client.AudioStreamManager.AudioStream.html">soundworks/client.AudioStreamManager.AudioStream</a></li><li><a href="module-soundworks_client.Auth.html">soundworks/client.Auth</a></li><li><a href="module-soundworks_client.Canvas2dRenderer.html">soundworks/client.Canvas2dRenderer</a></li><li><a href="module-soundworks_client.Canvas2dRenderingGroup.html">soundworks/client.Canvas2dRenderingGroup</a></li><li><a href="module-soundworks_client.CanvasView.html">soundworks/client.CanvasView</a></li><li><a href="module-soundworks_client.Checkin.html">soundworks/client.Checkin</a></li><li><a href="module-soundworks_client.ErrorReporter.html">soundworks/client.ErrorReporter</a></li><li><a href="module-soundworks_client.Experience.html">soundworks/client.Experience</a></li><li><a href="module-soundworks_client.FileSystem.html">soundworks/client.FileSystem</a></li><li><a href="module-soundworks_client.Geolocation.html">soundworks/client.Geolocation</a></li><li><a href="module-soundworks_client.Locator.html">soundworks/client.Locator</a></li><li><a href="module-soundworks_client.MotionInput.html">soundworks/client.MotionInput</a></li><li><a href="module-soundworks_client.Network.html">soundworks/client.Network</a></li><li><a href="module-soundworks_client.Placer.html">soundworks/client.Placer</a></li><li><a href="module-soundworks_client.Platform.html">soundworks/client.Platform</a></li><li><a href="module-soundworks_client.RawSocket.html">soundworks/client.RawSocket</a></li><li><a href="module-soundworks_client.SegmentedView.html">soundworks/client.SegmentedView</a></li><li><a href="module-soundworks_client.Service.html">soundworks/client.Service</a></li><li><a href="module-soundworks_client.SharedConfig.html">soundworks/client.SharedConfig</a></li><li><a href="module-soundworks_client.SharedParams.html">soundworks/client.SharedParams</a></li><li><a href="module-soundworks_client.Sync.html">soundworks/client.Sync</a></li><li><a href="module-soundworks_client.SyncScheduler.html">soundworks/client.SyncScheduler</a></li><li><a href="module-soundworks_client.View.html">soundworks/client.View</a></li><li><a href="module-soundworks_server.Activity.html">soundworks/server.Activity</a></li><li><a href="module-soundworks_server.AudioBufferManager.html">soundworks/server.AudioBufferManager</a></li><li><a href="module-soundworks_server.AudioStreamManager.html">soundworks/server.AudioStreamManager</a></li><li><a href="module-soundworks_server.Auth.html">soundworks/server.Auth</a></li><li><a href="module-soundworks_server.Checkin.html">soundworks/server.Checkin</a></li><li><a href="module-soundworks_server.Client.html">soundworks/server.Client</a></li><li><a href="module-soundworks_server.ErrorReporter.html">soundworks/server.ErrorReporter</a></li><li><a href="module-soundworks_server.Experience.html">soundworks/server.Experience</a></li><li><a href="module-soundworks_server.Geolocation.html">soundworks/server.Geolocation</a></li><li><a href="module-soundworks_server.Locator.html">soundworks/server.Locator</a></li><li><a href="module-soundworks_server.MetricScheduler.html">soundworks/server.MetricScheduler</a></li><li><a href="module-soundworks_server.Network.html">soundworks/server.Network</a></li><li><a href="module-soundworks_server.Osc.html">soundworks/server.Osc</a></li><li><a href="module-soundworks_server.Placer.html">soundworks/server.Placer</a></li><li><a href="module-soundworks_server.RawSocket.html">soundworks/server.RawSocket</a></li><li><a href="module-soundworks_server.Service.html">soundworks/server.Service</a></li><li><a href="module-soundworks_server.SharedConfig.html">soundworks/server.SharedConfig</a></li><li><a href="module-soundworks_server.SharedParams.html">soundworks/server.SharedParams</a></li><li><a href="module-soundworks_server.Sync.html">soundworks/server.Sync</a></li><li><a href="module-soundworks_server.SyncScheduler.html">soundworks/server.SyncScheduler</a></li></ul><h3>Namespaces</h3><ul><li><a href="module-soundworks_client.client.html">soundworks/client.client</a></li><li><a href="module-soundworks_client.viewport.html">soundworks/client.viewport</a></li><li><a href="module-soundworks_server.server.html">soundworks/server.server</a></li></ul><h3>Interfaces</h3><ul><li><a href="module-soundworks_client.AbstractAudioBufferManagerView.html">soundworks/client.AbstractAudioBufferManagerView</a></li><li><a href="module-soundworks_client.AbstractAuthView.html">soundworks/client.AbstractAuthView</a></li><li><a href="module-soundworks_client.AbstractCheckinView.html">soundworks/client.AbstractCheckinView</a></li><li><a href="module-soundworks_client.AbstractLocatorView.html">soundworks/client.AbstractLocatorView</a></li><li><a href="module-soundworks_client.AbstractPlacerView.html">soundworks/client.AbstractPlacerView</a></li><li><a href="module-soundworks_client.AbstractPlatformView.html">soundworks/client.AbstractPlatformView</a></li><li><a href="module-soundworks_client.AbstractView.html">soundworks/client.AbstractView</a></li></ul>
</nav>

<br class="clear">

<footer>
    
        Documentation generated by <a href="https://github.com/jsdoc3/jsdoc">JSDoc 3.5.5</a> on Mon Aug 06 2018 16:36:15 GMT+0200 (CEST)
    
</footer>

<script> prettyPrint(); </script>
<script src="scripts/linenumber.js"> </script>
</body>
</html>
